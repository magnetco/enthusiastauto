<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>1.8</story-id>
    <epic-id>1</epic-id>
    <title>Visual Fitment Compatibility Indicators</title>
    <status>Ready</status>
    <generated-date>2025-10-15</generated-date>
  </metadata>

  <user-story>
    <as-a>user with a selected vehicle</as-a>
    <i-want>see clear visual indicators showing which products are compatible</i-want>
    <so-that>I can quickly identify suitable parts without reading detailed specifications</so-that>
  </user-story>

  <acceptance-criteria>
    <criterion id="1">Compatible products show green checkmark badge with "Fits Your [Model]" text</criterion>
    <criterion id="2">Badge appears on product cards in listing view</criterion>
    <criterion id="3">Tooltip on compatible badge explains full compatibility (e.g., "Compatible with X4 2022")</criterion>
    <criterion id="4">Universal fit products (no fitment data) show "Check Fitment" warning badge in yellow</criterion>
    <criterion id="5">Products without fitment data display warning icon with tooltip explaining to verify compatibility</criterion>
    <criterion id="6">Consistent badge design using ShadCN Badge component across all views</criterion>
    <criterion id="7">Badges meet WCAG AA accessibility standards (don't rely on color alone - use icons + text)</criterion>
  </acceptance-criteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR010</section>
        <snippet>The system shall provide clear visual indicators when products are compatible with the user's selected BMW vehicle</snippet>
      </doc>
      <doc>
        <path>docs/epic-stories.md</path>
        <title>Epic Breakdown</title>
        <section>Story 8: Visual Fitment Compatibility Indicators</section>
        <snippet>Compatible products show green checkmark or "Fits Your BMW" badge. Universal fit products indicated differently. Products without fitment data show "Check Fitment" warning.</snippet>
      </doc>
      <doc>
        <path>docs/ux-specification.md</path>
        <title>UX/UI Specification</title>
        <section>4.2.1 Product Card Component</section>
        <snippet>Product card includes fitment badge (green checkmark or "Check Fitment"), vendor badge, stock status indicator</snippet>
      </doc>
      <doc>
        <path>docs/ux-specification.md</path>
        <title>UX/UI Specification</title>
        <section>4.2.8 Badge Component (ShadCN)</section>
        <snippet>Badge variants: success (green - compatible), warning (yellow - check fitment), error (red - incompatible/out of stock), neutral (gray - info, vendor)</snippet>
      </doc>
      <doc>
        <path>docs/ux-specification.md</path>
        <title>UX/UI Specification</title>
        <section>5.1 Color Palette</section>
        <snippet>Success Green (#22c55e) for "Fits Your BMW" badges and in-stock indicators. Warning Yellow (#f59e0b) for "Check Fitment" warnings and low stock alerts.</snippet>
      </doc>
      <doc>
        <path>docs/ux-specification.md</path>
        <title>UX/UI Specification</title>
        <section>7.2.1 Color and Contrast</section>
        <snippet>Never use color alone to convey information (use icons + text). All UI components must maintain 3:1 minimum contrast for WCAG AA compliance.</snippet>
      </doc>
      <doc>
        <path>docs/ux-specification.md</path>
        <title>UX/UI Specification</title>
        <section>7.2.3 Screen Reader Support</section>
        <snippet>Use semantic HTML and ARIA labels. Product cards need aria-label including fitment status. Dynamic content updates should use aria-live for announcements.</snippet>
      </doc>
      <doc>
        <path>docs/stories/story-1.2.md</path>
        <title>Story 1.2: Vehicle Fitment Filter</title>
        <section>Dev Notes - Architecture Context</section>
        <snippet>Vehicle selection stored in FilterContext (filters.vehicle). matchVehicle utility returns fitment status: "compatible" | "universal" | "incompatible"</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>components/FitmentBadge.tsx</path>
        <kind>component</kind>
        <symbol>FitmentBadge</symbol>
        <lines>1-85</lines>
        <reason>EXISTING - Badge component with 3 variants (compatible, check-fitment, universal). Already implements tooltips with ShadCN Tooltip. Needs verification against AC#1-7.</reason>
      </artifact>
      <artifact>
        <path>components/product-card.tsx</path>
        <kind>component</kind>
        <symbol>ProductCard</symbol>
        <lines>17-107</lines>
        <reason>EXISTING - Product card component that displays FitmentBadge. Already integrates matchVehicle and useFilters. Shows compatible and check-fitment variants. Needs verification against AC#2.</reason>
      </artifact>
      <artifact>
        <path>components/ui/tooltip.tsx</path>
        <kind>component</kind>
        <symbol>Tooltip, TooltipTrigger, TooltipContent, TooltipProvider</symbol>
        <lines>1-62</lines>
        <reason>EXISTING - ShadCN Tooltip component used by FitmentBadge for showing compatibility details. Installed during Story 1.2.</reason>
      </artifact>
      <artifact>
        <path>components/ui/badge.tsx</path>
        <kind>component</kind>
        <symbol>Badge</symbol>
        <lines>N/A</lines>
        <reason>EXISTING - ShadCN Badge component used as base for FitmentBadge styling. Provides variant system.</reason>
      </artifact>
      <artifact>
        <path>lib/utils/vehicle.ts</path>
        <kind>utility</kind>
        <symbol>matchVehicle</symbol>
        <lines>N/A</lines>
        <reason>EXISTING - Returns fitment status ("compatible" | "universal" | "incompatible") for given product and vehicle selection. Created in Story 1.2.</reason>
      </artifact>
      <artifact>
        <path>contexts/FilterContext.tsx</path>
        <kind>context</kind>
        <symbol>FilterContext, useFilters</symbol>
        <lines>N/A</lines>
        <reason>EXISTING - Provides filters.vehicle state (VehicleSelection | null) used to determine when to show badges. Created in Story 1.2.</reason>
      </artifact>
      <artifact>
        <path>lib/types/filters.ts</path>
        <kind>types</kind>
        <symbol>VehicleSelection</symbol>
        <lines>N/A</lines>
        <reason>EXISTING - Type definition for vehicle selection with model (string) and year (number). Used by FitmentBadge props.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="react" version="^19" />
        <package name="next" version="15" />
        <package name="typescript" version="^5" />
        <package name="@radix-ui/react-tooltip" version="^1.0.0" note="Required for ShadCN Tooltip" />
        <package name="lucide-react" version="latest" note="Icons: Check, AlertCircle" />
        <package name="tailwindcss" version="^3.4.0" />
        <package name="class-variance-authority" version="latest" note="For ShadCN Badge variants" />
      </node>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>FitmentBadgeProps</name>
      <kind>TypeScript interface</kind>
      <signature>
interface FitmentBadgeProps {
  variant: "compatible" | "check-fitment" | "universal";
  modelName?: string; // Required for compatible variant
  year?: number; // Optional for compatible tooltip
}
      </signature>
      <path>components/FitmentBadge.tsx</path>
    </interface>
    <interface>
      <name>matchVehicle</name>
      <kind>Function signature</kind>
      <signature>
function matchVehicle(
  product: Product,
  vehicle: VehicleSelection | null
): "compatible" | "universal" | "incompatible"
      </signature>
      <path>lib/utils/vehicle.ts</path>
    </interface>
    <interface>
      <name>VehicleSelection</name>
      <kind>TypeScript type</kind>
      <signature>
type VehicleSelection = {
  model: string; // e.g., "X4"
  year: number; // e.g., 2022
};
      </signature>
      <path>lib/types/filters.ts</path>
    </interface>
    <interface>
      <name>Tooltip Components</name>
      <kind>React components</kind>
      <signature>
TooltipProvider: Wraps tooltip tree, sets delayDuration (default 0)
Tooltip: Root tooltip component
TooltipTrigger: Element that triggers tooltip on hover/focus
TooltipContent: Tooltip content with arrow, customizable styling
      </signature>
      <path>components/ui/tooltip.tsx</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint>Next.js 15 with React Server Components - ProductCard uses "use client" directive for client-side interactivity</constraint>
    <constraint>TypeScript strict mode - All props and types must be properly defined</constraint>
    <constraint>ShadCN UI component patterns - Use Badge and Tooltip components as base, customize with Tailwind</constraint>
    <constraint>Lucide React icons - Use Check and AlertCircle icons, size h-3 w-3 for consistency</constraint>
    <constraint>WCAG AA accessibility - Icons + text required, minimum 3:1 contrast ratio, keyboard accessible tooltips</constraint>
    <constraint>Tailwind CSS dark mode - Use dark: prefix for dark mode variants (dark:bg-yellow-900/30, etc.)</constraint>
    <constraint>Mobile-first responsive design - Badges must display correctly on all viewport sizes (320px+)</constraint>
    <constraint>Color scheme from UX spec - Green (#22c55e or bg-green-600) for compatible, Yellow (#f59e0b or bg-yellow-100) for warnings</constraint>
    <constraint>Tooltip accessibility - Must be visible on keyboard focus (not just hover), use proper ARIA attributes</constraint>
    <constraint>Badge positioning - Display below price in ProductCard CardContent section with pt-1 spacing</constraint>
    <constraint>Conditional rendering - Only show badges when filters.vehicle !== null (user has selected vehicle)</constraint>
    <constraint>Fitment status mapping - compatible → green badge, universal → yellow warning, incompatible → filtered out (no badge)</constraint>
  </constraints>

  <tests>
    <standards>
      This is a Next.js 15 + React 19 + TypeScript project. Component testing should verify visual rendering, accessibility compliance, and interaction behavior. Use browser DevTools for WCAG contrast verification. Test with screen readers (VoiceOver on macOS, NVDA on Windows) for accessibility validation. Keyboard navigation testing required for tooltip focus states.
    </standards>

    <locations>
      <location>No test files exist yet - this is visual/UI testing focused on manual verification</location>
    </locations>

    <ideas>
      <idea ac-ids="1,6">Test compatible badge displays with correct green color (bg-green-600), Check icon, and "Fits Your [Model]" text</idea>
      <idea ac-ids="2,6">Test badge appears on ProductCard in correct position (below price, pt-1 spacing) when vehicle is selected</idea>
      <idea ac-ids="3">Test tooltip on compatible badge shows full compatibility info: "Compatible with [Model] [Year]"</idea>
      <idea ac-ids="4,6">Test check-fitment badge displays with yellow color (bg-yellow-100), AlertCircle icon, and "Check Fitment" text for products without fitment data</idea>
      <idea ac-ids="5">Test check-fitment tooltip shows warning message: "No fitment data available. Please verify compatibility before purchasing."</idea>
      <idea ac-ids="6">Test badges use ShadCN Badge component as base with consistent styling across all variants</idea>
      <idea ac-ids="7">Test WCAG AA compliance: icons + text present (not color alone), keyboard focus visible on tooltips, screen reader announces badge content</idea>
      <idea ac-ids="2">Test badge does NOT display when no vehicle is selected (filters.vehicle === null)</idea>
      <idea ac-ids="2">Test badge updates dynamically when vehicle selection changes</idea>
      <idea ac-ids="6,7">Test dark mode badge colors render correctly (dark:bg-green-600, dark:bg-yellow-900/30)</idea>
      <idea ac-ids="2,6">Test badge layout remains intact on mobile viewports (320px, 375px, 390px widths)</idea>
      <idea ac-ids="3,5,7">Test tooltip appears on hover (desktop) and focus (keyboard navigation)</idea>
      <idea ac-ids="7">Verify color contrast ratios with browser DevTools: green badge white text, yellow badge dark text</idea>
      <idea ac-ids="7">Test with VoiceOver/NVDA: verify badge text is announced, tooltip content is read on focus</idea>
    </ideas>
  </tests>

  <implementation-notes>
    <note>
      **STATUS: MOSTLY IMPLEMENTED**

      Story 1.8 features were largely implemented during Story 1.2 development:
      - FitmentBadge.tsx component EXISTS with all 3 variants (compatible, check-fitment, universal)
      - Tooltip support EXISTS using ShadCN Tooltip component
      - ProductCard integration EXISTS showing badges based on matchVehicle result
      - Icons EXISTS using Lucide React (Check, AlertCircle)

      **REMAINING WORK:**
      - Verify all acceptance criteria are fully met (AC#1-7)
      - Test accessibility compliance (WCAG AA, screen readers, keyboard navigation)
      - Verify color contrast ratios meet standards
      - Test responsive behavior on mobile viewports
      - Document implementation in Dev Agent Record
      - Update all task checkboxes in story file
      - Run TypeScript build to ensure no errors
      - Apply Prettier formatting

      **KEY VERIFICATION POINTS:**
      1. Compatible badge shows correct text: "Fits Your X4" (not "Fits Your BMW")
      2. Compatible tooltip shows year: "Compatible with X4 2022"
      3. Check-fitment badge appears for products without fitment tags (universal products)
      4. Badge positioning is consistent (below price, pt-1 spacing)
      5. Tooltips are keyboard accessible (visible on Tab focus, not just hover)
      6. Dark mode colors render correctly
      7. Screen reader announces badge content properly
    </note>
  </implementation-notes>
</story-context>
